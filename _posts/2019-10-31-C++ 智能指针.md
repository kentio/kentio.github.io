---
layout:     post
title:      C++ 智能指针
subtitle:   恰当使用智能指针可以防止内存错误
date:       2019-10-31
author:     kevin
header-img: img/green-bg.jpg
catalog: true
tags:
    - cpp
    - reading notes
---



## preface



最近复习了一些 C++ 方面的知识，越来越觉得编程语言都是相通的，特别是越精通底层的语言就越能够理解那些高级语言的特性，所以 C++ 还是得一直学下去，精通是不可能的，C++ 真的太复杂了，只能说尽量去了解它的这些特性，今天看到了 C++11 出现的新特性：**智能指针(smart pointer)**



## 智能指针是什么



说到这个问题之前我们先来看看之前我们申请动态内存时可能会存在的弊端：



### 内存泄露



我们可以看出下面这个函数是有问题的，每次调用函数时都会在堆上分配内存，但是从来没有将内存收回，从而导致了内存泄漏



```cpp
void remodel(std::string & str){
    std::string * ps = new std::string(str);
    str = *ps;
    return;
}
```



> 在[计算机科学](https://zh.wikipedia.org/wiki/计算机科学)中，**内存泄漏**指由于疏忽或错误造成程序未能释放已经不再使用的[内存](https://zh.wikipedia.org/wiki/内存)。内存泄漏并非指内存在物理上的消失，而是应用程序分配某段内存后，由于设计错误，导致在释放该段内存之前就失去了对该段内存的控制，从而造成了内存的浪费。
>
> 内存泄漏通常情况下只能由获得程序[源代码](https://zh.wikipedia.org/wiki/源代码)的程序员才能分析出来。  --[维基百科](https://zh.wikipedia.org/wiki/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F)



想起之前上课的时候老师一直说内存泄露，但是只是一句话带过，又不告诉我们内存泄露会怎样，如果内存泄露的话，那段泄露的内存就不能再被程序利用，导致系统可利用的内存越来越小。因此，如果是小型程序的话倒还好，危害不大，因为物理系统一般都有一个较大的内存量，要是大型程序比如跑在服务器端或者单片机中的程序，如果内存泄露了就会大大降低计算机的性能，除非重启程序，否则迟早出问题。



我自己试了一下，用 while 循环无限调用上面那个函数，录了个 gif 来让大家感受一下内存泄露是怎么个一回事：



![memory_leak](https://i.loli.net/2019/10/31/o4HkP2iEtUfA6Zv.gif)



可以看到，我电脑的内存使用量一直在上升，还好这个程序比较短，我可以知道他是因为内存泄露了，万一是个后台的大型程序，要是一直让这个程序跑的话，将极大衰减计算机性能。所以给我们提了个醒，一定要养成好习惯，申请了内存的话一定要记得释放



### 智能指针 



回归正题，说说我们的智能指针。通过上面的那段程序我们可以知道，在程序的最后加上一个 `delete` 关键字释放内存就可以避免内存泄露，但是总有些时候有可能会忘记的，所以这还不是最佳的方法。并且如果程序出现了异常而终止的话，申请的内存也不会被释放，像下面这样：



```cpp
void remodel(std::string & str){
    std::string * ps = new std::string(str);
    if (something_wrong){
        throw exception();
    }
    str = *ps;
    delete ps;
    return;
}
```



对于上面这段代码， ps 是我们申请的局部变量，所以程序退出时(无论是正常终止还是异常终止)，局部变量都会从栈内存中删除，因此 ps 所占据的内存将会被回收，但是 ps 所指向的内存却不一定被释放



智能指针是一个模板类，