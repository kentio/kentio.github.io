---
layout: post
title: C++调用PyTorch模型
subtitle: 利用libtorch转化模型
date: 2020-05-15
author: kevin
header-img: img/green-bg.jpg
catalog: true
tags:
    - docker
    - OpenCV
    - deep learning
    - pytorch
    - torchscript
    - cpp
---



## preface



上次在服务器上装上了 docker 版的 OpenCV，就是为本篇文章服务的，因为最近做模型的部署，就要用 C++ 调用 pytorch 的模型，pytorch 推出了 libtorch 来进行模型的部署，本篇文章就记录一下部署的过程。



## 转化模型



用 pytorch 训练完的模型必须要在 python 环境下才能够被调用，既然我们要让它能够被 C++ 调用那就得转化模型，pytorch 官方提出的 TorchScript 就是用来做这事的，TorchScript 是一种从 PyTorch 代码创建可序列化和可优化模型的方法。任何 TorchScript 程序都可以从 Python 进程中保存并在没有 Python 依赖项的进程中加载。



那么具体怎么做呢，也很简单，就是用 `torch.jit.trace` 对模型进行追踪，拿我们训练好的 mnist 模型来做例子(部分代码未给出，只有核心代码)，`torch.jit.trace` 函数接收模型和示例输入这两个参数，其中示例输入的尺寸要与模型的输入尺寸相同，为 `(1, channels, img_width, img_height)`，这里 LeNet 模型，输入的图像是单通道 28*28 大小的。这样模型就被追踪了，将其序列化为 `.pt` 后缀的模型文件，这样我们就离开了 python 的领域，准备跨入 C++ 领域了。



```python
import torch

model = Net().to('cpu')
optimizer = optim.SGD(model.parameters(), lr=0.001, momentum=0.9)
load_checkpoint('mnist-4690.pth', model, optimizer)
example = torch.rand(1, 1, 28, 28)
traced_model = torch.jit.trace(model, example)
output = traced_model(torch.ones(1, 1, 28, 28))
print(output)
traced_model.save('traced_mnist_pytorch_model.pt')
```



> 代码的输出为：tensor([[ -1.9272, -10.6155,  -0.5130,   4.6338,  -7.4411,   0.6665,  -8.3521,
>           -3.3505,  16.8189,   3.7142]], grad_fn=<DifferentiableGraphBackward>)



## 下载依赖库



C++ 读图像大多用 OpenCV，我们已经编译好了，然后还要用到官方的 `libtorch` 库，直接去[官网](https://pytorch.org/)下载对应的版本然后解压就行了，不需要安装。





cmake -DCMAKE_PREFIX_PATH=/libtorch ..



docker run -v /tmp/.X11-unix:/tmp/.X11-unix -e DISPLAY=$DISPLAY -p 5000:5000 -p 8889:8888 -e GRANT_SUDO=yes --user root -v ~/kevin/code/pytorch/pytorch-model-deployment:/pytorch-deployment -v ~/kevin/code/pytorch/libtorch:/libtorch -it spmallick/opencv-docker:opencv-3.4.3 /bin/bash